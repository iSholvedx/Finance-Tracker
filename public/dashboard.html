<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Finance Tracker</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header>
            <h1>Finance Tracker Dashboard</h1>
            <button id="logoutBtn">Logout</button>
        </header>

        <!-- Ringkasan -->
        <section id="summary">
            <h2>Ringkasan</h2>
            <div id="totalExpenses">Total Pengeluaran: Rp 0</div>
            <div id="totalIncome">Total Pemasukan: Rp 0</div>
            <div id="totalDebts">Total Hutang: Rp 0</div>
            <div id="totalUpcoming">Upcoming Income: Rp 0</div>
        </section>

        <!-- Tabs untuk kategori -->
        <nav>
            <button class="tab-btn active" data-tab="expenses">Pengeluaran Harian</button>
            <button class="tab-btn" data-tab="income">Pemasukan</button>
            <button class="tab-btn" data-tab="debts">Hutang</button>
            <button class="tab-btn" data-tab="upcomingIncome">Upcoming Income</button>
        </nav>

        <!-- Form tambah data (sama untuk semua tab, disesuaikan) -->
        <section id="addForm">
            <h3>Tambah Data</h3>
            <input type="date" id="date" required>
            <input type="text" id="description" placeholder="Deskripsi" required>
            <input type="number" id="amount" placeholder="Jumlah (Rp)" required>
            <input type="text" id="status" placeholder="Status (untuk hutang/upcoming)" style="display: none;">
            <button id="addBtn">Tambah</button>
        </section>

        <!-- Tabel data -->
        <section id="dataTable">
            <table>
                <thead id="tableHead">
                    <tr>
                        <th>Tanggal</th>
                        <th>Deskripsi</th>
                        <th>Jumlah</th>
                        <th>Status</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </section>
    </div>
    <script src="script.js"></script>
    <script>
        let currentData = {};
        let currentCategory = 'expenses';

        // Load data on start
        async function loadData() {
            const response = await fetch('/api/data');
            currentData = await response.json();
            updateSummary();
            renderTable(currentCategory);
        }

        // Update ringkasan
        function updateSummary() {
            const expenses = currentData.expenses.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const income = currentData.income.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const debts = currentData.debts.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);
            const upcoming = currentData.upcomingIncome.reduce((sum, item) => sum + parseFloat(item.amount || 0), 0);

            document.getElementById('totalExpenses').textContent = `Total Pengeluaran: Rp ${expenses.toLocaleString()}`;
            document.getElementById('totalIncome').textContent = `Total Pemasukan: Rp ${income.toLocaleString()}`;
            document.getElementById('totalDebts').textContent = `Total Hutang: Rp ${debts.toLocaleString()}`;
            document.getElementById('totalUpcoming').textContent = `Upcoming Income: Rp ${upcoming.toLocaleString()}`;
        }

        // Render tabel
        function renderTable(category) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';
            currentData[category].forEach(item => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.description}</td>
                    <td>Rp ${parseFloat(item.amount).toLocaleString()}</td>
                    <td>${item.status || '-'}</td>
                    <td>
                        <button onclick="editItem(${item.id}, '${category}')">Edit</button>
                        <button onclick="deleteItem(${item.id}, '${category}')">Hapus</button>
                    </td>
                `;
            });
        }

        // Tambah item
        document.getElementById('addBtn').addEventListener('click', async () => {
            const item = {
                date: document.getElementById('date').value,
                description: document.getElementById('description').value,
                amount: document.getElementById('amount').value,
                status: document.getElementById('status').value || ''
            };
            await fetch(`/api/data/${currentCategory}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(item)
            });
            loadData();
            clearForm();
        });

        // Edit item (sederhana: isi form dengan data lama)
        window.editItem = async (id, category) => {
            const item = currentData[category].find(i => i.id === id);
            document.getElementById('date').value = item.date;
            document.getElementById('description').value = item.description;
            document.getElementById('amount').value = item.amount;
            document.getElementById('status').value = item.status || '';
            // Hapus dulu, lalu tambah ulang setelah edit
            await fetch(`/api/data/${category}/${id}`, { method: 'DELETE' });
            // User bisa tambah ulang via form
        };

        // Hapus item
        window.deleteItem = async (id, category) => {
            await fetch(`/api/data/${category}/${id}`, { method: 'DELETE' });
            loadData();
        };

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                currentCategory = e.target.dataset.tab;
                
                // Sesuaikan form untuk hutang/upcoming
                const statusInput = document.getElementById('status');
                if (currentCategory === 'debts' || currentCategory === 'upcomingIncome') {
                    statusInput.style.display = 'block';
                    statusInput.placeholder = currentCategory === 'debts' ? 'Status (lunas/belum)' : 'Estimasi';
                } else {
                    statusInput.style.display = 'none';
                }
                
                renderTable(currentCategory);
            });
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await fetch('/logout', { method: 'POST' });
            window.location.href = '/index.html';
        });

        // Clear form
        function clearForm() {
            document.getElementById('date').value = '';
            document.getElementById('description').value = '';
            document.getElementById('amount').value = '';
            document.getElementById('status').value = '';
        }

        // Init
        loadData();
    </script>
</body>
</html>